[include ./btc_variables.cfg]  # Required
[include ./tool_0.cfg]         # Required
[include ./tool_1.cfg]         # Required if second tool available, and so on
[include ./tool_2.cfg]
[include ./tool_3.cfg]
[include ./tool_4.cfg]
[include ./tool_5.cfg]
[include ./bashed_macros.cfg]  # Comment out once done at least 100 iterations of toolchange
[include ./btc_printstart_end_gcode.cfg]     # Uncomment when doing tool alignment using zruncho nudge tool
#[include ./btc_nudge.cfg]     # Uncomment if using Dockslide
#[include ./btc_spoolman.cfg]     # Uncomment for Spoolman integration
[input_shaper]                 # Required for input shaper, do not delete


    
[gcode_macro _UPDATE_FRONTEND]
gcode:
  # Somehow SET_GCODE_VARIABLE is case sensitive.
  # Since Fluidd is using a lowercase Tx macro name,
  # we need to use lowercase names, too.
  {% set tool_current_asperbtc = printer["gcode_macro _btc_Variables"].tool_current_asperbtc %}
  {% set numoftool = printer["gcode_macro _btc_Variables"].numoftool %}
  {% for toolnumber in numoftool %}
    {% set active = toolnumber == tool_current_asperbtc %}

    {% if "active" in printer["gcode_macro t" ~ toolnumber] %}
      { action_respond_info("Setting tool " ~ toolnumber ~ " active: " ~ active) }
      SET_GCODE_VARIABLE MACRO=t{toolnumber} VARIABLE=active VALUE={active}
    {% endif %}

    {% if printer["gcode_macro _btc_Variables"].btc_enable_spoolman_integration %}
      {% if active and "spool_id" in printer["gcode_macro t" ~ toolnumber] %}
        { action_respond_info("Tool " ~ toolnumber ~ " is active. Active spool is now " ~ printer["gcode_macro t" ~ toolnumber].spool_id) }
        SET_ACTIVE_SPOOL ID={ printer["gcode_macro t" ~ toolnumber].spool_id }
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if printer["gcode_macro _btc_Variables"].btc_enable_spoolman_integration and tool_current_asperbtc == -1 %}
    { action_respond_info("No tool is active; clearing active spool") }
    CLEAR_ACTIVE_SPOOL
  {% endif %}

### start Printer start routine ###
[delayed_gcode start_check_carriage]
initial_duration: 3
gcode:
  {% set numoftool = [] %}
  {% for tools in range(6) %}
    {% if printer["gcode_macro t" + tools|string] is defined %}
      _start_populate_tools TOOLNUMBER={tools}
      { action_respond_info("BTC: Tool %d is defined" % (tools)) }
    {% endif %}
  {% endfor %}
  Check_Carriage
  _start_check_second
  {% if printer["gcode_macro Dockslide_Home"] is defined %}
    { action_respond_info("BTC: Dockslide is in use") }
    SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=use_dockslide VALUE=True
  {% else %}
    { action_respond_info("BTC: Dockslide is not in use") }
  {% endif %}
  {% set base_limit_accel = printer.toolhead.max_accel %}
  {% set base_limit_scv = printer.toolhead.square_corner_velocity %}
  SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=base_limit_accel VALUE={base_limit_accel}
  SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=base_limit_scv VALUE={base_limit_scv}

[gcode_macro _start_populate_tools]
gcode:
  {% set numoftool = printer["gcode_macro _btc_Variables"].numoftool + [params.TOOLNUMBER|int] %}
  SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=numoftool VALUE='{numoftool}'

[gcode_macro _start_check_second]
gcode:
  {% set toolnumber = printer["gcode_macro _btc_Variables"].tool_current_asperbtc %}
  {% if toolnumber == -1 %}
    { action_respond_info("BTC: Carriage has no tool on startup!") }
  {% endif %}
### end Printer start routine ###

### start Check state of carriage ###
[gcode_macro Check_Carriage]
gcode:
  { action_respond_info("BTC: Check carriage start. Setting carriage to NO TOOL") }
  {% set numoftool = printer["gcode_macro _btc_Variables"].numoftool %}
  SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=tool_current_asperbtc VALUE=-1
  {% for toolnumber in numoftool %}
    _checkasperbtc TOOLNUMBER={toolnumber}
  {% endfor %}
  _UPDATE_FRONTEND

[gcode_macro _checkasperbtc]
gcode:
  {% set toolnumber = params.TOOLNUMBER|default(0)|int %}
  {% set tool_current_asperbtc = printer["gcode_macro _btc_Variables"].tool_current_asperbtc %}
  {% if tool_current_asperbtc < 0 %}
    _CHECK_CARRIAGE_SECOND TOOLNUMBER={toolnumber}
  {% endif %}





[gcode_macro _CHECK_CARRIAGE_SECOND]
gcode:
  {% set toolnumber = params.TOOLNUMBER|default(0)|int %}
  {% set frompickup = params.FROMPICKUP|default(0)|int %}
  {% set carriage_state = printer["gcode_button carriagesense_t" + toolnumber|string].state %}
  {% set toolvar = printer["gcode_macro _Variables_t" + toolnumber|string] %}
  {% set tool_xoffset = toolvar.xoffset|float %}
	{% set tool_yoffset = toolvar.yoffset|float %}
	{% set tool_zoffset = toolvar.zoffset|float %}
  {% set tool_shaperfreq_x = toolvar.shaperfreq_x %}
  {% set tool_shaperfreq_y = toolvar.shaperfreq_y %}
  {% set tool_shapertype_x = toolvar.shapertype_x %}
  {% set tool_shapertype_y = toolvar.shapertype_y %}
  #{% set tool_pressure_advance = toolvar.pressure_advance %}
  {% set tool_pressure_advance_smooth_time = toolvar.pressure_advance_smooth_time %}
  {% set tool_z_hop = printer["gcode_macro _btc_Variables"].btc_z_hop %}
  {% set inc_leds = printer["gcode_macro _btc_Variables"].btc_inc_leds %}
  {% set tool_zoffset = toolvar.zoffset %}
  {% set z_adjust = printer["gcode_macro _btc_Variables"].gcode_offset_z_adjust %}
  {% set tool_approachlocation_z = printer["gcode_macro _btc_Variables"].tool_approachlocation_z %}
  #{% set tool_pickupmove_z = printer["gcode_macro _btc_Variables"].tool_pickupmove_z %}


  
  {% set last_z = printer["gcode_macro _btc_Variables"].last_z %}
  {% set prev_offset = printer["gcode_macro _btc_Variables"].prev_offset %}
  {% set toolvar2 = printer["gcode_macro _btc_Variables"] %}
  {% set tool_pickupmove_z = toolvar2.tool_pickupmove_z %}
  {% set safe_y_location = toolvar2.safe_y_location %}
  {% set pos_z = printer.toolhead.position.z %}
  {% set tool_z_down_feedrate = toolvar2.z_down_speed * 60 %}
  {% set tool_travel_feedrate = toolvar2.btc_travel_speed * 60 %}
  
  {% if carriage_state == "RELEASED" %}
    { action_respond_info("BTC: T%d at carriage" % (toolnumber)) }
    SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=tool_current_asperbtc VALUE={toolnumber}
    {% if toolnumber == 0 %}
      ACTIVATE_EXTRUDER EXTRUDER=extruder
    {% else %}
      ACTIVATE_EXTRUDER EXTRUDER=extruder{toolnumber}
    {% endif %}
    {% if 'x' in printer.toolhead.homed_axes and 'y' in printer.toolhead.homed_axes %}
      SET_GCODE_OFFSET X={tool_xoffset} Y={tool_yoffset} move=1	#Apply the nozzle XY offset so that printing proceeds smoothly
      {% if tool_approachlocation_z > 0 %}
        SET_GCODE_OFFSET MOVE=1 Z={tool_zoffset} #apply the z offset before loading the new one to ensure no nozzle crash
        SET_GCODE_OFFSET MOVE=1 Z_ADJUST={z_adjust}
        { action_respond_info("BTC: Z offset now %f (adjusted by %f)" % (tool_zoffset, z_adjust)) }
      {% endif %}
    {% endif %}
    SET_INPUT_SHAPER SHAPER_FREQ_X={tool_shaperfreq_x} SHAPER_FREQ_Y={tool_shaperfreq_y} SHAPER_TYPE_X={tool_shapertype_x} SHAPER_TYPE_Y={tool_shapertype_y}
    SET_PRESSURE_ADVANCE SMOOTH_TIME={tool_pressure_advance_smooth_time}
    {% if frompickup == 1 %}
      {% if tool_z_hop != 0 %}



        SAVE_GCODE_STATE NAME=TOOL_ZHOP_STATE
        G90
        G0 Y{safe_y_location} F{tool_travel_feedrate}
        G0 Z{last_z + 0.5} F{tool_z_down_feedrate}
        #G0 Z{last_z + 0.5} D60 F{tool_z_down_feedrate}
        #G0 X175 Y310 D0 F10000
        RESTORE_GCODE_STATE NAME=TOOL_ZHOP_STATE

        
      {% endif %}
      {% set fanspeed = printer["gcode_macro _btc_Variables"].last_fan_speed|float %}
      {% if fanspeed > 0 %}
        #M106 S{fanspeed}
        M107
        SET_FAN_SPEED FAN=partfan{toolnumber} SPEED={fanspeed|float}
      {% endif %}
      { action_respond_info("BTC: Setting partfan%d to %f" % (toolnumber, fanspeed)) }
    {% endif %}
  {% else %}
    { action_respond_info("BTC: T%d not at carriage" % (toolnumber)) }
    SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=tool_current_asperbtc VALUE=-1
    {% if frompickup == 1 %}
      {% if printer['print_stats'].state == "printing" %}
        { action_respond_info("BTC: Tool %s not detected at carriage!! Pausing print..." % (toolnumber)) }
        G91
        G0 Y50
        G90
        G0 Z{last_z}
        pause
      {% else %}
        { action_raise_error("BTC: Tool %s not detected at carriage!!" % (toolnumber)) }
      {% endif %}
    {% endif %}
  {% endif %}
### end Check state of carriage ###

### start Check dock state ###

 
### start Tool pickup routine ###
[gcode_macro Tool_Pickup]
gcode:
  {% set toolnumber = params.TOOLNUMBER|default(0)|int %}
  {% set fromhoming = params.FROMHOMING|default(0)|int %}
  {% set pos_z = printer.toolhead.position.z %}
  SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=last_z VALUE={pos_z}
  {% if 'xy' in printer.toolhead.homed_axes %}
    Check_Carriage
    _tool_pickup_second TOOLNUMBER={toolnumber} FROMHOMING={fromhoming}
  {% else %}
    { action_raise_error("Must home xy first!") }
  {% endif %}
  _UPDATE_FRONTEND





[gcode_macro _tool_pickup_second]
gcode:
  {% set toolnumber = params.TOOLNUMBER|default(0)|int %}
  {% set fromhoming = params.FROMHOMING|default(0)|int %}
  {% set toolvar = printer["gcode_macro _btc_Variables"] %}
  {% set tool_z_hop = toolvar.btc_z_hop %}
  {% set tool_current_asperbtc = toolvar.tool_current_asperbtc %}
  {% set use_dockslide = toolvar.use_dockslide %}
  {% set performed_dropoff = False %}
  {% set pickuplocation_z = toolvar.pickuplocation_z %}
  {% set dropofflocation_z = toolvar.dropofflocation_z %}
  {% set tool_zoffset = printer["gcode_macro _Variables_t" + toolnumber|string].zoffset %}
  {% set prev_offset = printer["gcode_macro _btc_Variables"].prev_offset %}
  {% set pos_z = printer.toolhead.position.z - prev_offset%}
  
      SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=prev_offset VALUE={tool_zoffset}
      SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=last_z VALUE={pos_z}
      
  {% if tool_current_asperbtc != toolnumber %}
      {% if tool_z_hop != 0 %}
      SAVE_GCODE_STATE NAME=TOOL_ZHOP_STATE
      RESTORE_GCODE_STATE NAME=TOOL_ZHOP_STATE
     {% endif %} 
 {% if tool_current_asperbtc > -1 %}
      SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=last_z VALUE={pos_z}
      SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=prev_offset VALUE={tool_zoffset}
      SAVE_GCODE_STATE NAME=TOOL_ZHOP_STATE
      RESTORE_GCODE_STATE NAME=TOOL_ZHOP_STATE
      SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=last_z VALUE={pos_z}
      SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=prev_offset VALUE={tool_zoffset}
      { action_respond_info("BTC: Pickup tool %d, active tool is %d. Now dropping off active tool" % (toolnumber, tool_current_asperbtc)) }
      SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=from_pickup VALUE=True
      {% if fromhoming == 1 %}
        {% set toolvars = printer["gcode_macro _Variables_t" + tool_current_asperbtc|string] %}
        {% set tool_xoffset = toolvars.xoffset|float * -1 %}
        {% set tool_yoffset = toolvars.yoffset|float * -1 %}
        SET_GCODE_OFFSET X={tool_xoffset} Y={tool_yoffset} move=1
      {% endif %}
      Tool_Dropoff TOOLNUMBER={tool_current_asperbtc} FROMPICKUP=1
      {% set performed_dropoff = True %}
    {% endif %}

    { action_respond_info("BTC: Pickup tool %d" % (toolnumber)) }
    {% set tool_travel_feedrate = toolvar.btc_travel_speed * 60 %}
    {% set tool_change_feedrate = toolvar.btc_toolchange_speed * 60 %}
    {% set tool_wipe_feedrate = toolvar.btc_wipe_speed * 60 %}
    {% set tool_z_up_feedrate = toolvar.z_up_speed * 60 %}  
    {% set tool_approachlocation_y = toolvar.tool_approachlocation_y %}
    {% set tool_approachlocation_z = toolvar.tool_approachlocation_z %}
    {% set safe_y_location = toolvar.safe_y_location %}
    {% set pickuplocation_z = toolvar.pickuplocation_z %}
    {% set tool_pickupmove_y = toolvar.tool_pickupmove_y %}
    {% set tool_pickupmove_z = toolvar.tool_pickupmove_z %}
    {% set base_limit_accel = toolvar.base_limit_accel %}
    {% set base_limit_scv = toolvar.base_limit_scv %}
    {% set tool_pickuplocation_x = printer["gcode_macro _Variables_t" + toolnumber|string].pickuplocation_x %}
    {% set tool_zoffset = printer["gcode_macro _Variables_t" + toolnumber|string].zoffset %}
    {% set z_adjust = toolvar.gcode_offset_z_adjust %}

    {% if tool_approachlocation_z == 0 %}
      SET_GCODE_OFFSET MOVE=1 Z={tool_zoffset}
      SET_GCODE_OFFSET MOVE=1 Z_ADJUST={z_adjust}
    {% else %}
      SET_GCODE_OFFSET MOVE=1 Z=0
      SET_GCODE_OFFSET MOVE=1 Z_ADJUST=0
    {% endif %}

    { action_respond_info("BTC: Z offset now %f (adjusted by %f)" % (tool_zoffset, z_adjust)) }

    {% set last_limit_accel = printer.toolhead.max_accel %}
    {% set last_limit_scv = printer.toolhead.square_corner_velocity %}
    SET_VELOCITY_LIMIT ACCEL={base_limit_accel} SQUARE_CORNER_VELOCITY={base_limit_scv}
    SAVE_GCODE_STATE NAME=TOOL_PICKUP_STATE

    { action_respond_info("BTC: Move to approach location X%d Y%d Z%d" % (tool_pickuplocation_x, tool_approachlocation_y, tool_approachlocation_z)) }
    G90
    G0 X{tool_pickuplocation_x} Y{tool_approachlocation_y} F{tool_travel_feedrate}
    G0 Z{pickuplocation_z} D0 F{tool_z_up_feedrate}
    G0 X{tool_pickuplocation_x} Y{tool_approachlocation_y} D0 F{tool_travel_feedrate}
    
    
    {% if use_dockslide %}
      {% if (not performed_dropoff) or (tool_approachlocation_z > 0) %}
        { action_respond_info("BTC: Dockslide Deploy") }
        Dockslide_Deploy
      {% endif %}
    {% endif %}
    { action_respond_info("BTC: Slide into tool Y+%.1f" % (tool_pickupmove_y)) }
    G0 Y{tool_approachlocation_y + tool_pickupmove_y + 5} D0 F{tool_travel_feedrate}
    G91
    G0 Y-5 F1000
   

    { action_respond_info("BTC: Lift Z by %.1f to engage tool" % (tool_pickupmove_z)) }
    G91
    G0 Z{tool_pickupmove_z} F{tool_change_feedrate}
    G90
    G0 Y{safe_y_location} F{tool_travel_feedrate}
    G90
    {% if use_dockslide %}
      { action_respond_info("BTC: Dockslide Park") }
      Dockslide_Park
    {% endif %}
    
    RESTORE_GCODE_STATE NAME=TOOL_PICKUP_STATE
    SET_VELOCITY_LIMIT ACCEL={last_limit_accel} SQUARE_CORNER_VELOCITY={last_limit_scv}
     M400  ; đảm bảo tất cả chuyển động đã hoàn thành
     ; Kiểm tra các thao tác
    _CHECK_CARRIAGE_SECOND TOOLNUMBER={toolnumber} FROMPICKUP=1
   {% endif %}



  {% if printer.print_stats.state == "printing" %}
  #; Nếu máy đang in, hạ xuống về layer in
  {% set pos = printer.toolhead.position %}
  G90
  G0 X{pos.x} Y{pos.y} F22000  ; Sau đó di chuyển đến đúng vị trí X/Y đang in
  G91
  G0 Z-0.5 F10000     ; Trả đầu in về đúng độ cao layer đang in
  G90
  {% endif %}


### end Tool pickup routine ###

### start Tool dropoff routine ###    

### end Tool pickup routine ###

### start Tool dropoff routine ###
[gcode_macro Tool_Dropoff]
gcode:
  {% set toolnumber = params.TOOLNUMBER|default(0)|int %}
  {% set frompickup = params.FROMPICKUP|default(0)|int %}
  {% if 'xy' in printer.toolhead.homed_axes %}
    {% if frompickup != 1 %}
      Check_Carriage
    {% else %}
      {% set frompickuptxt = "FROMPICKUP=1" %}
    {% endif %}
    _tool_dropoff_second TOOLNUMBER={toolnumber} {frompickuptxt}
  {% else %}
    { action_raise_error("Must home xy first!") }
  {% endif %}
  _UPDATE_FRONTEND





[gcode_macro _tool_dropoff_second]
gcode:

  {% set toolvar = printer["gcode_macro _btc_Variables"] %}
  {% set tool_current_asperbtc = toolvar.tool_current_asperbtc|int %}
  {% set use_dockslide = toolvar.use_dockslide %}
  {% set toolnumber = params.TOOLNUMBER|default(tool_current_asperbtc)|int %}
  {% set frompickup = params.FROMPICKUP|default(0)|int %}
  {% set toolnumber = params.TOOLNUMBER|default(0)|int %} #
  {% set frompickup = params.FROMPICKUP|default(0)|int %} #
  {% set toolvar = printer["gcode_macro _btc_Variables"] %} #
  {% set tool_current_asperbtc = toolvar.tool_current_asperbtc|int %} #
  {% set use_dockslide = toolvar.use_dockslide %} #
  {% if toolnumber == tool_current_asperbtc|int %}
    { action_respond_info("BTC: Dropoff tool %d, active tool is %s - Proceeding dropoff" % (toolnumber, tool_current_asperbtc)) }
    {% set tool_z_up_feedrate = toolvar.z_up_speed * 60 %}  
    {% set tool_travel_feedrate = toolvar.btc_travel_speed * 60 %}
    {% set tool_change_feedrate = toolvar.btc_toolchange_speed * 60 %}
    {% set tool_dropofflocation_x = printer["gcode_macro _Variables_t" + toolnumber|string].dropofflocation_x %}
    {% set safe_y_location = toolvar.safe_y_location %}
    {% set tool_approachlocation_y = toolvar.tool_approachlocation_y %}
    {% set tool_approachlocation_z = toolvar.tool_approachlocation_z %}
    {% set dropofflocation_z = toolvar.dropofflocation_z %}
    {% set tool_dropoffmove_y = toolvar.tool_dropoffmove_y %}
    {% set tool_dropoffmove_z = toolvar.tool_dropoffmove_z %}
    {% set base_limit_accel = toolvar.base_limit_accel %}
    {% set base_limit_scv = toolvar.base_limit_scv %}

    SET_GCODE_OFFSET MOVE=1 X=0 Y=0

    {% set last_limit_accel = printer.toolhead.max_accel %}
    {% set last_limit_scv = printer.toolhead.square_corner_velocity %}
    SET_VELOCITY_LIMIT ACCEL={base_limit_accel} SQUARE_CORNER_VELOCITY={base_limit_scv}

    SAVE_GCODE_STATE NAME=TOOL_DROPOFF_STATE


    { action_respond_info("BTC: Move to dropoff wait Z height %d" % (tool_approachlocation_z)) }
    G91
    G0 Z1 F12000
    G90
    G0 X{tool_dropofflocation_x} Y{safe_y_location} F24000
    G90
    G0 Z{dropofflocation_z} F{tool_z_up_feedrate}
    { action_respond_info("BTC: Move to dropoff wait position X%d Y%d" % (tool_dropofflocation_x, tool_approachlocation_y)) }
    G0 Y{tool_approachlocation_y} D0 F{tool_travel_feedrate * 1}

    { action_respond_info("BTC: Move to dropoff dock Y%d" % (tool_approachlocation_y + tool_dropoffmove_y)) }
    G0 Y{tool_approachlocation_y + tool_dropoffmove_y} F{tool_travel_feedrate * 1}

    { action_respond_info("BTC: Lower tool for release Z%d" % (tool_approachlocation_z + tool_dropoffmove_z)) }
    G91
    G0 Z{tool_dropoffmove_z} F{tool_change_feedrate}
    G90
    { action_respond_info("BTC: Retract from dock Y%d" % (tool_approachlocation_y)) }
    G0 Y{tool_approachlocation_y} F{tool_travel_feedrate * 1.5}

    RESTORE_GCODE_STATE NAME=TOOL_DROPOFF_STATE
    SET_VELOCITY_LIMIT ACCEL={last_limit_accel} SQUARE_CORNER_VELOCITY={last_limit_scv}
    M400
  {% else %}
    { action_raise_error("BTC: Dropoff tool %d but active tool is %s, aborting" % (toolnumber, tool_current_asperbtc)) }
  {% endif %}


### end Tool dropoff routine ###

### start Fan and temperature override ###
[gcode_macro M106]
gcode:
  {% if params.S is defined %}
    {% set converted_speeds = params.S|int / 255 %}
    {% if converted_speeds > 1 %}
      {% set converted_speed = 1 %}
    {% else %}
      {% set converted_speed = converted_speeds %}
    {% endif %}
  {% else %}
    {% set converted_speed = 1.0 %}
  {% endif %}
  {% if params.P is defined %}
    SET_FAN_SPEED FAN=partfan{params.P} SPEED={converted_speed|float}
  {% else %}
    {% set curtool = printer["gcode_macro _btc_Variables"].tool_current_asperbtc %}
    M107
    SET_FAN_SPEED FAN=partfan{curtool} SPEED={converted_speed|float}
    SET_GCODE_VARIABLE MACRO=_btc_Variables VARIABLE=last_fan_speed VALUE={converted_speed}
  {% endif %}

[gcode_macro M107]
gcode:
  {% if params.P is defined %}
    SET_FAN_SPEED FAN=partfan{params.P} SPEED=0.0
  {% else %}
    {% set numoftool = printer["gcode_macro _btc_Variables"].numoftool %}
    {% for toolnumber in numoftool %}
      SET_FAN_SPEED FAN=partfan{toolnumber} SPEED=0.0
    {% endfor %}
  {% endif %}

########################################################################################
# This override was created by Ellis @ https://ellis3dp.com as part of his Useful Macros
# Modified for use in Btc
[gcode_macro M109]
rename_existing: M99109
gcode:
    #Parameters
    {% set btc_temp_allow = printer["gcode_macro _btc_Variables"].btc_temp_allow %}
    {% set s = params.S|float %}
    {% if params.T is defined %}
      {% set p = params.T|int %}
      M104 S{s} T{p}  ; Set hotend temp
      {% if p == 0 %}
        {% set extrudernum = "" %}
      {% else %}
        {% set extrudernum = p %}
      {% endif %}
      {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder{extrudernum} MINIMUM={s-btc_temp_allow} ; MAXIMUM={s+1+btc_temp_allow}   ; Wait for hotend temp (within 1 degree)
      {% endif %}
    {% else %}
      M104 S{s}  ; Set hotend temp
      {% set toolcurrent = printer.toolhead.extruder %}
      {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR={toolcurrent} MINIMUM={s-btc_temp_allow} ; MAXIMUM={s+1+btc_temp_allow}   ; Wait for hotend temp (within 1 degree)
      {% endif %}
    {% endif %}
########################################################################################
  
########################################################################################
########################################################################################

########################################################################################
# Example for startup usage:
# [delayed_gcode startup_sanity_check]
# initial_duration: 3
# gcode:
### end Led effect ###########################################

##################################################################
# Klicky probe
# We hijack this macro to make sure attached probe is at Carriage
[gcode_macro _entry_point]
gcode:
  {% if params.FUNCTION == "Attach_Probe" %}
    Check_Carriage
	  _entry_point_second function={params.FUNCTION}
	{% elif params.FUNCTION == "homing_override" %}
	  {% set use_dockslide = printer["gcode_macro _btc_Variables"].use_dockslide %}
	  {% if use_dockslide %}
	    {% set dockslide_status = printer["gcode_macro _dockslide_variables"].dockslide_status %}
	    {% if dockslide_status != 1 %}
	      {% set dockslide_homed = printer["gcode_macro _dockslide_variables"].dockslide_homed %}
	      {% if dockslide_homed %}
	        Dockslide_Park
	      {% else %}
	        Dockslide_Home
	      {% endif %}
	    {% endif %}
	    SET_GCODE_VARIABLE MACRO=_dockslide_variables VARIABLE=doing_homing VALUE=True
	  {% endif %}
	  _entry_point_third function={params.FUNCTION}
	{% else %}
	  _entry_point_third function={params.FUNCTION}
  {% endif %}



  
[gcode_macro _entry_point_second]
gcode:
  {% set use_dockslide = printer["gcode_macro _btc_Variables"].use_dockslide %}
  {% if use_dockslide %}
    SET_GCODE_VARIABLE MACRO=_dockslide_variables VARIABLE=doing_homing VALUE=False
  {% endif %}

  { action_respond_info("BTC: Skipping tool checks — assuming Klicky is fixed on carriage.") }

  _entry_point_third function={params.FUNCTION}

  
[gcode_macro _entry_point_third]
gcode:
### Klicky original macros ###
    {% set function  = 'pre_' ~ params.FUNCTION %}
    {% if printer["gcode_macro _User_Variables"] is defined %}
      {% set move_accel = printer["gcode_macro _User_Variables"].move_accel|default(1000) %}
    {% elif printer["gcode_macro _lip_variables"] is defined %}
      {% set move_accel = printer["gcode_macro _lip_variables"].move_accel|default(1000) %}
    {% else %}
      {% set move_accel = 1000 %}
    {% endif %}
    # mandatory to save the new safe position
    M400
    SAVE_GCODE_STATE NAME={function}
    # removes the Z offset for better bed based docking
    SET_GCODE_OFFSET Z=0
    # all the macros initially assume absolute positioning
    G90
    # set a safe(sane) Acceleration
    SET_VELOCITY_LIMIT ACCEL={move_accel}
### end Klicky original macros ###
### End Klicky ########################################################################################################
