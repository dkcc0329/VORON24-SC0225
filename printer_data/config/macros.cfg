#####
# GENERAL MACROS
#####
# [gcode_macro RESUME]
# description: Resumes the print if the printer is paused.
# rename_existing: RESUME_BASE
# gcode:
# 	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
# 	# Prime
# 	{% if printer.extruder.can_extrude|lower == 'true' %}
# 		G91
# 		G1 E{E} F2100
# 		G90
# 	{% else %}
# 		{action_respond_info("Extruder not hot enough")}
# 	{% endif %}
# 	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description: Cancels the printer
rename_existing: CANCEL_PRINT_BASE
gcode:
	END_PRINT
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	CANCEL_PRINT_BASE

#####
# START PRINT MACROS
# Call this from your slicer (custom g-code). 
# Read more here: https://rat-rig.github.io/V-CoreOS/#/slicers
#####

[gcode_macro PRINT_START]
gcode:
  # Lấy dữ liệu từ slicer
  {% set target_bed = params.BED|default(60)|int %}
  {% set target_extruder = params.EXTRUDER|default(200)|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  # === BƯỚC 1: Home máy ===
  STATUS_HOMING
  G28
  G90
  BED_MESH_CLEAR

  # === BƯỚC 2: Bắt đầu gia nhiệt SONG SONG ===
  M140 S{target_bed}                         ; Bàn: bắt đầu nóng (không đợi)
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150  ; Hotend: bắt đầu 150°C

  # Di chuyển đến giữa bàn
  G1 X{x_wait} Y{y_wait} Z15 F9000

  # === BƯỚC 3: Cân bằng QGL (trong lúc nóng) ===
  SET_DISPLAY_TEXT MSG="QGL..."
  STATUS_LEVELING
  QUAD_GANTRY_LEVEL
  G28 Z

  # === BƯỚC 4: Đợi hotend 175°C để mesh chính xác ===
  SET_DISPLAY_TEXT MSG="Hotend 175°C"
  M109 S150

  # === BƯỚC 5: BED MESH THEO VÙNG IN (ADAPTIVE) ===
  SET_DISPLAY_TEXT MSG="Adaptive Mesh"
  STATUS_MESHING

  {% if params.PRINT_MIN and params.PRINT_MAX %}
    # Lấy vùng in từ Orca Slicer
    {% set min_x = params.PRINT_MIN.split(',')[0]|float %}
    {% set min_y = params.PRINT_MIN.split(',')[1]|float %}
    {% set max_x = params.PRINT_MAX.split(',')[0]|float %}
    {% set max_y = params.PRINT_MAX.split(',')[1]|float %}

    # Tạo mesh chỉ trong vùng in + biên an toàn 5mm
    BED_MESH_CALIBRATE AREA_START={min_x-5},{min_y-5} AREA_END={max_x+5},{max_y+5}
  {% else %}
    # Nếu không có vùng → mesh toàn bàn (dự phòng)
    BED_MESH_CALIBRATE
  {% endif %}

  # === BƯỚC 6: Đợi bàn đạt nhiệt (nếu chưa) ===
  M190 S{target_bed}

  # === BƯỚC 7: Gia nhiệt hotend đến in ===
  SET_DISPLAY_TEXT MSG="Hotend {target_extruder}°C"
  STATUS_HEATING
  G1 X{x_wait} Y{y_wait} Z15 F9000
  M107
  M109 S{target_extruder}

  # === BƯỚC 8: Bắt đầu in ===
  SET_DISPLAY_TEXT MSG="Đang in..."
  STATUS_PRINTING
  LINE_PURGE
  G90
#####
# END PRINT MACROS
# Call this from your slicer (custom g-code). 
# Read more here: https://rat-rig.github.io/V-CoreOS/#/slicers
#####

[gcode_macro PRINT_END]
gcode:
    # Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    #M106 S0
    # relative mode
    G91
    # Move nozzle away from print while retracting
    G1 E-3 F300
    # Raise nozzle by 10mm
    G1 Z10 F3000
    # absolute mode
    G90
    G1 X175 Y345 F6000
#======================================================
# LOAD FILAMENT
#======================================================
[gcode_macro LOAD_FILAMENT]
gcode:
    SAVE_GCODE_STATE NAME=loading_filament
    M117 Loading Filament
    M220 S{100}
    G91         
    G92 E0
    G1 E100 F300
    G92 E0
    RESTORE_GCODE_STATE NAME=loading_filament

#======================================================
# UNLOAD FILAMENT
#======================================================
[gcode_macro UNLOAD_FILAMENT]
gcode:
    SAVE_GCODE_STATE NAME=unloading_filament
    M117 Unloading Filament 
    M220 S{100}
    G91 # set relative
    G92 E0
    G1 E10 F300     
    G1 E-100 F300 # the E is the length of the bowden tube (120mm) + 100 mm. 
    G92 E0
    RESTORE_GCODE_STATE NAME=unloading_filament